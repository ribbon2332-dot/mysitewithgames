<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can-Do Magic Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
    }
    </script>
    <style>
        body { font-family: 'Fredoka', sans-serif; background-color: #4f46e5; margin: 0; overflow-x: hidden; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        @keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>
    <div id="root" class="flex flex-col items-center justify-center min-h-screen text-white">
        <div class="animate-pulse text-xl">Loading Magic...</div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';

        // --- DATA ---
        const SUBJECTS = ["I","You","He","She","It","We","They"];
        const VERBS = ["read","ride","run","sing","skateboard","swim","write","think","shut"];
        const SUBJECT_TRANSLATIONS = {"I":"–Ø","You":"–¢—ã","He":"–û–Ω","She":"–û–Ω–∞","It":"–û–Ω–æ","We":"–ú—ã","They":"–û–Ω–∏"};
        const SUBJECT_EMOJIS = {"I":"üôã","You":"ü´µ","He":"üë¶","She":"üëß","It":"ü§ñ","We":"üë®‚Äçüë©‚Äçüë¶","They":"üë•"};
        const VERB_TRANSLATIONS = {"read":"—á–∏—Ç–∞—Ç—å","ride":"–µ–∑–¥–∏—Ç—å/–∫–∞—Ç–∞—Ç—å—Å—è","run":"–±–µ–≥–∞—Ç—å","sing":"–ø–µ—Ç—å","skateboard":"–∫–∞—Ç–∞—Ç—å—Å—è –Ω–∞ —Å–∫–µ–π—Ç–µ","swim":"–ø–ª–∞–≤–∞—Ç—å","write":"–ø–∏—Å–∞—Ç—å","think":"–¥—É–º–∞—Ç—å","shut":"–∑–∞–∫—Ä—ã–≤–∞—Ç—å"};
        const VERB_EMOJIS = {"read":"üìñ","ride":"üö¥","run":"üèÉ","sing":"üé§","skateboard":"üõπ","swim":"üèä","write":"‚úçÔ∏è","think":"ü§î","shut":"üö™"};

        // --- ICONS ---
        const DiceIcon = () => (<svg className="w-8 h-8 md:w-10 md:h-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></svg>);
        const SparklesIcon = () => (<svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M7 5h4"/></svg>);
        const VolumeIcon = () => (<svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>);
        const BookIcon = () => (<svg className="w-8 h-8 text-white/50" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>);
        const ArrowLeft = () => (<svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>);
        const ArrowRight = () => (<svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>);
        const TrophyIcon = () => (<svg className="w-6 h-6 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M20.2 6.5C19.8 4.2 18 2.5 15.8 2.5H8.2c-2.2 0-4 1.7-4.4 4C1.3 7.1 0 9.8 0 12c0 3 2.1 5.5 5 6.4V20c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-1.6c2.9-.9 5-3.4 5-6.4 0-2.2-1.3-4.9-3.8-5.5zM5 12c0-1.8.8-3.4 2-4.5V14c-1.2-1.1-2-2.7-2-2zm14 0c0 1.6-1.1 3-2.7 3.6V8.4C17.9 9 19 10.4 19 12z"/></svg>);
        const HomeIcon = () => (<svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
        const EarIcon = () => (<svg className="w-6 h-6 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9a6 6 0 1 1 12 0v7a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3v-7Z"/><path d="M6 9v7a3 3 0 0 1-3 3h0"/><path d="M18 9v7a3 3 0 0 0 3 3h0"/></svg>);
        const PictureIcon = () => (<svg className="w-6 h-6 text-teal-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>);
        const MagicIcon = () => (<svg className="w-6 h-6 text-pink-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M7 5h4"/></svg>);
        const LightningIcon = () => (<svg className="w-6 h-6 text-orange-500" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>);
        const TimerIcon = () => (<svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>);

        // --- DICE COMPONENT ---
        const DiceCube = ({ content, isRolling, colorClass, label, icon, manualControls, onPrev, onNext }) => {
          return (
            <div className="flex flex-col items-center">
              <span className="mb-2 text-white font-bold text-lg tracking-wide uppercase shadow-sm">{label}</span>
              <div className="flex items-center gap-2 md:gap-4">
                {manualControls && (
                    <button onClick={onPrev} className="p-2 rounded-full bg-white/20 hover:bg-white/40 text-white transition-all active:scale-95">
                        <ArrowLeft />
                    </button>
                )}
                
                <div className="relative w-28 h-28 md:w-36 md:h-36 perspective-1000 group">
                    <div 
                        className={`w-full h-full relative transform-style-3d transition-all duration-500 ${isRolling ? 'animate-[spin_0.5s_linear_infinite]' : 'group-hover:rotate-y-12'}`}
                        style={{ transformStyle: 'preserve-3d' }}
                    >
                    <div className={`absolute inset-0 w-full h-full ${colorClass} rounded-2xl shadow-2xl flex flex-col items-center justify-center border-4 border-white/20 z-10`} style={{ backfaceVisibility: 'hidden' }}>
                        {icon && <div className="mb-2 text-white/90 transform scale-110">{icon}</div>}
                        <span className="text-xl md:text-2xl font-extrabold text-white uppercase text-center break-words px-1 leading-tight drop-shadow-md select-none">
                        {content || "?"}
                        </span>
                    </div>
                    <div className="absolute inset-0 w-full h-full bg-slate-800 rounded-2xl shadow-xl flex items-center justify-center border-4 border-white/10" style={{ transform: 'rotateY(180deg)', backfaceVisibility: 'hidden' }}>
                        <DiceIcon />
                    </div>
                    </div>
                    <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 w-20 h-3 bg-black/20 blur-md rounded-full transition-all duration-300 group-hover:w-24 group-hover:bg-black/30" />
                </div>

                {manualControls && (
                    <button onClick={onNext} className="p-2 rounded-full bg-white/20 hover:bg-white/40 text-white transition-all active:scale-95">
                        <ArrowRight />
                    </button>
                )}
              </div>
            </div>
          );
        };

        const Confetti = () => {
            return (
                <div className="absolute inset-0 overflow-hidden pointer-events-none z-50">
                    {[...Array(20)].map((_, i) => (
                        <div 
                            key={i}
                            className="absolute w-3 h-3 rounded-full animate-[fall_3s_ease-out_forwards]"
                            style={{
                                left: `${Math.random() * 100}%`,
                                top: '-20px',
                                backgroundColor: ['#f43f5e', '#3b82f6', '#eab308', '#22c55e', '#a855f7'][Math.floor(Math.random() * 5)],
                                animationDelay: `${Math.random() * 0.5}s`,
                                transform: `rotate(${Math.random() * 360}deg)`
                            }}
                        />
                    ))}
                </div>
            )
        }

        // --- APP ---
        const App = () => {
            const [view, setView] = useState('menu'); 
            
            // Mode States
            const [subject, setSubject] = useState(null);
            const [verb, setVerb] = useState(null);
            const [isRolling, setIsRolling] = useState(false);
            const [generatedSentence, setGeneratedSentence] = useState(null);
            const [isLoadingAI, setIsLoadingAI] = useState(false);
            const [isAnswerRevealed, setIsAnswerRevealed] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            
            // Challenge/Listening/Visual/Speed Mode State
            const [challengeTarget, setChallengeTarget] = useState(null); 
            const [userSIndex, setUserSIndex] = useState(0);
            const [userVIndex, setUserVIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [challengeStatus, setChallengeStatus] = useState('guessing');

            // Speed Mode specific
            const [timeLeft, setTimeLeft] = useState(60);
            const [isGameOver, setIsGameOver] = useState(false);
            const [highScore, setHighScore] = useState(0);
            const [speedType, setSpeedType] = useState('text'); // 'text' or 'emoji'

            const [userApiKey, setUserApiKey] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            
            const rollIntervalRef = useRef(null);

            // Logic...
            const rollDice = () => {
                if (isRolling) return;
                setIsRolling(true);
                setGeneratedSentence(null);
                setSubject(null);
                setVerb(null);
                setIsAnswerRevealed(false);
                let count = 0;
                rollIntervalRef.current = setInterval(() => {
                    setSubject(SUBJECTS[Math.floor(Math.random() * SUBJECTS.length)]);
                    setVerb(VERBS[Math.floor(Math.random() * VERBS.length)]);
                    count++;
                    if (count > 15) {
                        if (rollIntervalRef.current) clearInterval(rollIntervalRef.current);
                        const finalS = SUBJECTS[Math.floor(Math.random() * SUBJECTS.length)];
                        const finalV = VERBS[Math.floor(Math.random() * VERBS.length)];
                        setSubject(finalS);
                        setVerb(finalV);
                        setIsRolling(false);
                    }
                }, 80);
            };

            const startChallenge = () => {
                const s = SUBJECTS[Math.floor(Math.random() * SUBJECTS.length)];
                const v = VERBS[Math.floor(Math.random() * VERBS.length)];
                setChallengeTarget({ s, v });
                setChallengeStatus('guessing');
                setUserSIndex(Math.floor(Math.random() * SUBJECTS.length));
                setUserVIndex(Math.floor(Math.random() * VERBS.length));
                
                if (view === 'speed') {
                    setSpeedType(Math.random() > 0.5 ? 'text' : 'emoji');
                }
            };

            const startSpeedGame = () => {
                setView('speed');
                setScore(0);
                setTimeLeft(60);
                setIsGameOver(false);
                startChallenge();
            };

            useEffect(() => {
                if (view === 'speed' && !isGameOver && timeLeft > 0) {
                    const timer = setInterval(() => {
                        setTimeLeft(t => {
                            if (t <= 1) {
                                setIsGameOver(true);
                                if (score > highScore) setHighScore(score);
                                return 0;
                            }
                            return t - 1;
                        });
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [view, isGameOver, timeLeft, score, highScore]);

            const checkChallenge = () => {
                const userS = SUBJECTS[userSIndex];
                const userV = VERBS[userVIndex];
                
                const isCorrect = userS === challengeTarget.s && userV === challengeTarget.v;

                if (isCorrect) {
                    setChallengeStatus('correct');
                    setScore(s => s + 1);
                    
                    if (view === 'speed') {
                        // Speed mode logic: Immediate transition, bonus time
                        setTimeLeft(t => t + 3);
                        startChallenge(); // Immediate next
                        speakText("Good!");
                    } else {
                        // Standard mode logic
                        setShowConfetti(true);
                        setTimeout(() => setShowConfetti(false), 3000);
                        speakText("Correct! " + userS + " can " + userV);
                        setTimeout(() => startChallenge(), 2500); 
                    }
                } else {
                    setChallengeStatus('wrong');
                    speakText("Try again!");
                    
                    if (view === 'speed') {
                        setTimeLeft(t => Math.max(0, t - 5));
                        setTimeout(() => setChallengeStatus('guessing'), 500);
                    } else {
                        setTimeout(() => setChallengeStatus('guessing'), 1000);
                    }
                }
            };

            useEffect(() => {
                if (view !== 'menu' && view !== 'free' && view !== 'story' && view !== 'speed') startChallenge();
            }, [view]);

            const getAiStory = async (s, v) => {
                if (!s || !v) return;
                setIsLoadingAI(true);
                setGeneratedSentence(null);
                // ... same as before
                setTimeout(() => {
                     setGeneratedSentence(`Once upon a time, ${s} decided to ${v}. It was a beautiful day. ${s} was very happy!`);
                     setIsLoadingAI(false);
                }, 1000);
            };
            
            const getAiExample = async () => {
                 // ... same as before
                 if (!subject || !verb) return;
                 setGeneratedSentence(`${subject} can ${verb}!`);
            };


            const speakText = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            };

            const playTargetAudio = () => {
                if(challengeTarget) {
                    speakText(`${challengeTarget.s} can ${challengeTarget.v}`);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-violet-700 flex flex-col items-center justify-center p-4 relative overflow-hidden">
                    {showConfetti && <Confetti />}
                    
                    {/* Common Header / Settings */}
                    <button onClick={() => setShowSettings(!showSettings)} className="absolute top-4 right-4 text-white/50 hover:text-white text-2xl z-50">‚öôÔ∏è</button>
                    {showSettings && (
                        <div className="absolute top-14 right-4 bg-white p-4 rounded-xl shadow-xl z-50 w-72 text-gray-800">
                            <input type="text" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} placeholder="API Key..." className="w-full border p-2 rounded mb-2 text-sm" />
                        </div>
                    )}
                    
                    {view !== 'menu' && (
                         <button onClick={() => setView('menu')} className="absolute top-4 left-4 text-white bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl backdrop-blur-md flex items-center gap-2 font-bold transition-all z-40">
                            <HomeIcon /> Menu
                        </button>
                    )}

                    {/* Header */}
                    <header className="mb-8 mt-16 text-center relative z-10">
                        <h1 className="text-3xl md:text-5xl font-black text-white drop-shadow-xl flex flex-wrap items-center justify-center gap-3">
                            {view === 'challenge' ? <span className="bg-yellow-400 text-indigo-900 rounded-xl p-2"><TrophyIcon /></span> : 
                             view === 'listening' ? <span className="bg-purple-400 text-indigo-900 rounded-xl p-2"><EarIcon /></span> :
                             view === 'visual' ? <span className="bg-teal-400 text-indigo-900 rounded-xl p-2"><PictureIcon /></span> :
                             view === 'story' ? <span className="bg-pink-500 text-white rounded-xl p-2"><MagicIcon /></span> :
                             view === 'speed' ? <span className="bg-orange-500 text-white rounded-xl p-2"><LightningIcon /></span> :
                             <span className="bg-white text-indigo-600 rounded-xl p-2"><DiceIcon /></span>}
                            <span>{view === 'menu' ? 'Can-Do Games' : (view === 'speed' ? 'Speed Run' : 'Challenge')}</span>
                        </h1>
                        {/* Score for modes */}
                        {view !== 'menu' && view !== 'free' && view !== 'story' && (
                            <div className="mt-4 flex items-center gap-4 justify-center text-white font-bold">
                                {view === 'speed' && (
                                    <div className={`flex items-center gap-2 px-4 py-1 rounded-lg ${timeLeft < 10 ? 'bg-red-500 animate-pulse' : 'bg-white/20 backdrop-blur-md'}`}>
                                        <TimerIcon /> {timeLeft}s
                                    </div>
                                )}
                                <div className="bg-white/20 backdrop-blur-md rounded-lg px-4 py-1 inline-flex items-center gap-2">
                                    Score: {score} <TrophyIcon />
                                </div>
                            </div>
                        )}
                    </header>

                    {/* MENU VIEW */}
                    {view === 'menu' && (
                        <main className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 animate-[fadeIn_0.5s] max-w-4xl mx-auto w-full relative z-10">
                             <button onClick={() => setView('free')} className="bg-white/10 hover:bg-white/20 border-2 border-white/20 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 shadow-2xl backdrop-blur-xl text-center">
                                <div className="bg-white text-indigo-600 p-3 rounded-2xl text-3xl mb-1">üé≤</div>
                                <h3 className="text-xl font-black text-white">Free Play</h3>
                                <p className="text-indigo-200 text-xs">–ü—Ä–æ—Å—Ç–æ –∫–∏–¥–∞–π –∫—É–±–∏–∫–∏</p>
                            </button>
                            <button onClick={() => setView('challenge')} className="bg-white/10 hover:bg-white/20 border-2 border-white/20 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 shadow-2xl backdrop-blur-xl text-center">
                                <div className="bg-yellow-400 text-indigo-900 p-3 rounded-2xl text-3xl mb-1">üèÜ</div>
                                <h3 className="text-xl font-black text-white">Challenge</h3>
                                <p className="text-indigo-200 text-xs">–ü–µ—Ä–µ–≤–æ–¥–∏ —Ñ—Ä–∞–∑—ã</p>
                            </button>
                            <button onClick={() => setView('listening')} className="bg-white/10 hover:bg-white/20 border-2 border-white/20 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 shadow-2xl backdrop-blur-xl text-center">
                                <div className="bg-purple-400 text-indigo-900 p-3 rounded-2xl text-3xl mb-1">üëÇ</div>
                                <h3 className="text-xl font-black text-white">Listening</h3>
                                <p className="text-indigo-200 text-xs">–°–ª—É—à–∞–π –∏ —Å–æ–±–∏—Ä–∞–π</p>
                            </button>
                            <button onClick={() => setView('visual')} className="bg-white/10 hover:bg-white/20 border-2 border-white/20 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 shadow-2xl backdrop-blur-xl text-center">
                                <div className="bg-teal-400 text-indigo-900 p-3 rounded-2xl text-3xl mb-1">üñºÔ∏è</div>
                                <h3 className="text-xl font-black text-white">Visual</h3>
                                <p className="text-indigo-200 text-xs">–£–≥–∞–¥–∞–π –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º</p>
                            </button>
                            <button onClick={() => setView('story')} className="bg-white/10 hover:bg-white/20 border-2 border-white/20 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 shadow-2xl backdrop-blur-xl text-center">
                                <div className="bg-pink-500 text-white p-3 rounded-2xl text-3xl mb-1">‚ú®</div>
                                <h3 className="text-xl font-black text-white">Magic Stories</h3>
                                <p className="text-indigo-200 text-xs">–°–æ–∑–¥–∞–π –∏—Å—Ç–æ—Ä–∏—é</p>
                            </button>
                             <button onClick={startSpeedGame} className="bg-white/10 hover:bg-white/20 border-2 border-white/20 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 shadow-2xl backdrop-blur-xl text-center border-orange-400/50">
                                <div className="bg-orange-500 text-white p-3 rounded-2xl text-3xl mb-1">‚ö°</div>
                                <h3 className="text-xl font-black text-white">Speed Run</h3>
                                <p className="text-indigo-200 text-xs">–ù–∞ —Å–∫–æ—Ä–æ—Å—Ç—å!</p>
                            </button>
                        </main>
                    )}

                    {/* GAME VIEWS */}
                    {view !== 'menu' && (
                        <main className="w-full max-w-4xl bg-white/10 backdrop-blur-xl rounded-[2rem] p-6 md:p-8 shadow-2xl border border-white/20 relative overflow-hidden min-h-[400px] flex flex-col items-center justify-center animate-[slideUp_0.3s_ease-out] z-10">
                            
                            {/* GAME OVER OVERLAY for Speed Mode */}
                            {view === 'speed' && isGameOver && (
                                <div className="absolute inset-0 bg-indigo-900/95 z-50 flex flex-col items-center justify-center text-center p-8 animate-[fadeIn_0.3s]">
                                    <h2 className="text-4xl font-black text-white mb-4">TIME'S UP!</h2>
                                    <div className="text-6xl mb-6">üèÅ</div>
                                    <p className="text-indigo-200 text-xl mb-2">Final Score</p>
                                    <p className="text-6xl font-black text-white mb-8">{score}</p>
                                    <div className="flex gap-4">
                                        <button onClick={() => setView('menu')} className="bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-xl font-bold">Menu</button>
                                        <button onClick={startSpeedGame} className="bg-orange-500 hover:bg-orange-400 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2"><LightningIcon /> Play Again</button>
                                    </div>
                                </div>
                            )}

                            {/* TARGETS AREA */}
                            {(challengeTarget && view !== 'free' && view !== 'story') && (
                                <div className="mb-8 text-center w-full animate-[bounce_2s_infinite]">
                                    {/* Normal Challenge or Speed (Text) */}
                                    {(view === 'challenge' || (view === 'speed' && speedType === 'text')) && (
                                        <>
                                            <p className="text-indigo-200 text-sm uppercase font-bold tracking-widest mb-2">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ñ—Ä–∞–∑—É:</p>
                                            <div className="bg-white text-indigo-900 px-6 py-3 rounded-2xl text-xl md:text-3xl font-black shadow-lg transform rotate-1">
                                                {SUBJECT_TRANSLATIONS[challengeTarget.s]} —É–º–µ–µ—Ç {VERB_TRANSLATIONS[challengeTarget.v]}?
                                            </div>
                                        </>
                                    )}
                                    {/* Visual or Speed (Emoji) */}
                                    {(view === 'visual' || (view === 'speed' && speedType === 'emoji')) && (
                                        <>
                                            <p className="text-indigo-200 text-sm uppercase font-bold tracking-widest mb-2">–£–≥–∞–¥–∞–π –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º:</p>
                                            <div className="flex gap-4 justify-center items-center">
                                                 <div className="bg-white text-4xl md:text-6xl p-4 rounded-2xl shadow-lg border-4 border-teal-200 transform -rotate-6">{SUBJECT_EMOJIS[challengeTarget.s]}</div>
                                                 <div className="text-white text-4xl flex items-center font-black drop-shadow-lg">+</div>
                                                 <div className="bg-white text-4xl md:text-6xl p-4 rounded-2xl shadow-lg border-4 border-teal-200 transform rotate-6">{VERB_EMOJIS[challengeTarget.v]}</div>
                                            </div>
                                        </>
                                    )}
                                    {/* Listening */}
                                    {view === 'listening' && (
                                        <>
                                            <p className="text-indigo-200 text-sm uppercase font-bold tracking-widest mb-2">–ü–æ—Å–ª—É—à–∞–π –∏ —Å–æ–±–µ—Ä–∏:</p>
                                            <button onClick={playTargetAudio} className="bg-purple-500 hover:bg-purple-400 text-white px-8 py-4 rounded-full text-2xl font-black shadow-lg flex items-center gap-3 mx-auto transition-transform active:scale-95 animate-pulse">
                                                <VolumeIcon /> PLAY SOUND
                                            </button>
                                        </>
                                    )}
                                </div>
                            )}
                            
                            {/* Dice Area */}
                            <div className="flex flex-col md:flex-row justify-center items-center gap-8 md:gap-16 mb-8 relative z-10">
                                <DiceCube 
                                    content={(view === 'free' || view === 'story') ? (subject ? SUBJECT_TRANSLATIONS[subject] : "?") : SUBJECTS[userSIndex]} 
                                    isRolling={isRolling} 
                                    colorClass="bg-gradient-to-br from-pink-500 to-rose-600"
                                    label={(view === 'free' || view === 'story') ? "–ö—Ç–æ?" : "Subject"}
                                    manualControls={view !== 'free' && view !== 'story'}
                                    onPrev={() => setUserSIndex(i => (i - 1 + SUBJECTS.length) % SUBJECTS.length)}
                                    onNext={() => setUserSIndex(i => (i + 1) % SUBJECTS.length)}
                                />
                                
                                <div className="flex items-center justify-center pt-6 md:pt-0">
                                    <span className="text-5xl md:text-6xl font-black text-white/90 drop-shadow-[0_4px_0_rgba(0,0,0,0.2)] uppercase tracking-widest transform md:-rotate-12 bg-clip-text">
                                        CAN
                                    </span>
                                </div>
                                
                                <DiceCube 
                                    content={(view === 'free' || view === 'story') ? (verb ? VERB_TRANSLATIONS[verb] : "?") : VERBS[userVIndex]} 
                                    isRolling={isRolling} 
                                    colorClass="bg-gradient-to-br from-cyan-500 to-blue-600"
                                    label={(view === 'free' || view === 'story') ? "–î–µ–π—Å—Ç–≤–∏–µ" : "Verb"}
                                    icon={(view === 'free' || view === 'story') && verb ? <span className="text-5xl filter drop-shadow-sm leading-none">{VERB_EMOJIS[verb]}</span> : (view !== 'free' && view !== 'story' ? <span className="text-5xl filter drop-shadow-sm leading-none">{VERB_EMOJIS[VERBS[userVIndex]]}</span> : <BookIcon />)}
                                    manualControls={view !== 'free' && view !== 'story'}
                                    onPrev={() => setUserVIndex(i => (i - 1 + VERBS.length) % VERBS.length)}
                                    onNext={() => setUserVIndex(i => (i + 1) % VERBS.length)}
                                />
                            </div>

                            {/* CONTROLS */}
                            <div className="flex flex-col items-center gap-6 relative z-10 w-full">
                                {(view === 'free' || view === 'story') ? (
                                    <>
                                        <button onClick={rollDice} disabled={isRolling} className={`relative px-10 py-4 bg-yellow-400 hover:bg-yellow-300 text-indigo-900 font-black text-2xl rounded-full shadow-[0_6px_0_rgb(161,98,7)] active:shadow-none active:translate-y-1.5 transition-all w-full md:w-auto ${isRolling ? 'opacity-90' : ''}`}>{isRolling ? "ROLLING..." : "ROLL DICE"}</button>
                                        {/* Result Areas ... */}
                                    </>
                                ) : (
                                    <div className="w-full flex justify-center mt-4">
                                        {challengeStatus === 'correct' ? (
                                            <div className="bg-green-500 text-white px-8 py-3 rounded-2xl font-black text-2xl animate-bounce shadow-lg flex items-center gap-2">‚úÖ CORRECT!</div>
                                        ) : (
                                            <button onClick={checkChallenge} className={`px-10 py-4 font-black text-2xl rounded-full shadow-lg transition-all transform ${challengeStatus === 'wrong' ? 'bg-red-500 animate-pulse text-white' : 'bg-green-400 hover:bg-green-300 text-green-900 shadow-[0_6px_0_rgb(21,128,61)] active:shadow-none active:translate-y-1.5'}`}>{challengeStatus === 'wrong' ? "TRY AGAIN ‚ùå" : "CHECK ANSWER"}</button>
                                        )}
                                    </div>
                                )}
                            </div>
                        </main>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>